---
title: "ZENCODE Advanced RNA-seq training"
author: "Damir"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r tidy=TRUE}

source("functions.R")
library("DESeq2")
library("ggplot2")
library("vsn")
library("pheatmap")
library("RColorBrewer")
library("maSigPro")

```


```{r tidy=TRUE}

path <- "/mnt/storage/DANIO-CODE/"
assay <- "RNA-seq"
pattern <- "*.ReadsPerGene.out.tab"
biosamples <- c("DCD006716BS", "DCD006712BS")
geneCountFiles <- unlist(lapply(biosamples, function(x)
  listFilesInBiosamples(path, assay, x, pattern)))
type <- rep(c("wt", "mut"), each = 2)
repl <- rep(c("1", "2"), times = 2)
sample <- Map(function(x, y) paste(x, y, sep = ""), type, repl)
geneCountFiles <- setNames(geneCountFiles, sample)
allReadsCounts <- lapply(geneCountFiles, readTagsPerGene)
geneNames <- lapply(allReadsCounts, row.names)
geneList <- Reduce(function(w, z) mapply(function(x, y) if (x == y) x else NA, w, z, SIMPLIFY = TRUE), geneNames)
identical(names(geneList), geneNames[[1]])
totalReadsCount <- sapply(allReadsCounts, function(x) x$totalCount)
rownames(totalReadsCount) <- geneNames[[1]]
coldata <- data.frame(mutation = c("wt", "wt", "mutant", "mutant"))
row.names(coldata) <- sample

```


```{R tidy=TRUE}

dds <- DESeqDataSetFromMatrix(countData = totalReadsCount,
                              colData = coldata,
                              design = ~ mutation)
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]
dds$mutation <- relevel(dds$mutation, ref = "wt")
dds 
dds <- DESeq(dds)
res <- results(dds)
summary(res)
resLFC <- lfcShrink(dds, coef=2)
summary(resLFC)

```

```{r tidy=TRUE}

plotMA(res, ylim =c(-2, 2))
plotMA(resLFC, ylim=c(-2,2))
d <- plotCounts(dds, gene=which.min(res$padj), intgroup="mutation", 
                returnData=TRUE)
ggplot(d, aes(x=mutation, y=count)) + 
  geom_point(position=position_jitter(w=0.1,h=0)) + 
  scale_y_log10(breaks=c(100,1000,5000))

```


```{r tidy=TRUE}

vsd <- vst(dds, blind=FALSE)
rld <- rlog(dds, blind=FALSE)
ntd <- normTransform(dds)
meanSdPlot(assay(ntd))
meanSdPlot(assay(vsd))
meanSdPlot(assay(rld))

plotPCA(vsd, intgroup=c("mutation"))



```

```{r tidy=TRUE}

#select <- order(rowMeans(counts(dds,normalized=TRUE)),
#                decreasing=TRUE)[1:30]
#df <- as.data.frame(colData(dds)[,c("mutation")])
#rownames(df) <- colnames(assay(ntd)[select,])
#pheatmap(assay(ntd)[select,], cluster_rows=FALSE, show_rownames=FALSE,
#         cluster_cols=FALSE, annotation_col=df)

sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- vsd$mutation
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
pheatmap(sampleDistMatrix,
         clustering_distance_rows=sampleDists,
         clustering_distance_cols=sampleDists,
         col=colors)

```
```{r tidy=TRUE}

biosamples <- c("DCD006716BS", "DCD006714BS", "DCD006715BS", "DCD006712BS", "DCD006713BS", "DCD006710BS")
geneCountFiles <- unlist(lapply(biosamples, function(x)
  listFilesInBiosamples(path, assay, x, pattern)))
type <- rep(c("wt", "mut"), each = 6)
repl <- rep(c("1", "2"), times = 6)
time = rep(c("24", "48", "72"), each = 2, times = 2)
sample <- Map(function(x, y, z) paste(x, y, z, sep = "_"), type, time, repl)
geneCountFiles <- setNames(geneCountFiles, sample)
allReadsCounts <- lapply(geneCountFiles, readTagsPerGene)
geneNames <- lapply(allReadsCounts, row.names)
geneList <- Reduce(function(w, z) mapply(function(x, y) if (x == y) x else NA, w, z, SIMPLIFY = TRUE), geneNames)
identical(names(geneList), geneNames[[1]])
totalReadsCount <- sapply(allReadsCounts, function(x) x$totalCount)
rownames(totalReadsCount) <- geneNames[[1]]
coldata <- data.frame(condition = type, time = time)
row.names(coldata) <- sample

```

```{r tidy=TRUE}

sample1 <- c("wt_48_1", "wt_48_2", "mut_48_1", "mut_48_2")
sample1Coldata <- data.frame(condition = coldata[sample1, "condition"], row.names = sample1)
vsd <- genericDESeq(dataCounts = totalReadsCount[,sample1], coldata = sample1Coldata, design = NA, designVariations = c("wt", "mut"))
plotPCA(vsd, intgroup=c("condition"))

sample2 <- c("wt_24_1", "wt_24_2", "wt_48_1", "wt_48_2")
sample2Coldata <- data.frame(condition = coldata[sample2, "time"], row.names = sample2)
vsd <- genericDESeq(dataCounts = totalReadsCount[,sample2], coldata = sample2Coldata, design = NA, designVariations = c("24", "48"))
plotPCA(vsd, intgroup=c("condition"))

sample <- c("wt_24_1", "wt_24_2", "wt_72_1", "wt_72_2")
sampleColdata <- data.frame(condition = coldata[sample, "time"], row.names = sample)
vsd <- genericDESeq(dataCounts = totalReadsCount[,sample], coldata = sampleColdata, design = NA, designVariations = c("24", "72"))
plotPCA(vsd, intgroup=c("condition"))

sample <- c("wt_48_1", "wt_48_2", "wt_72_1", "wt_72_2")
sampleColdata <- data.frame(condition = coldata[sample, "time"], row.names = sample)
vsd <- genericDESeq(dataCounts = totalReadsCount[,sample], coldata = sampleColdata, design = NA, designVariations = c("48", "72"))
plotPCA(vsd, intgroup=c("condition"))

sample <- c("wt_72_1", "wt_72_2", "mut_72_1", "mut_72_2")
sampleColdata <- data.frame(condition = coldata[sample, "condition"], row.names = sample)
vsd <- genericDESeq(dataCounts = totalReadsCount[,sample], coldata = sampleColdata, design = NA, designVariations = c("wt", "mut"))
plotPCA(vsd, intgroup=c("condition"))

```

```{r tidy=TRUE}

see.genes(sigs$sig.genes$MutantvsControl, show.fit = TRUE, dis = design$dis, cluster.method = "hclust", cluster.data = 1, k.mclust = TRUE)

```